import React from "react";
import { checkUserSessionAction, updateAccountSubscriptionsAction,clearAccountSubscriptionsAction } from "../action/AccountAction";
import { login, createAccount, logout } from "../service/AccountService";
import {RootState} from "../store";
import {connect, ConnectedProps} from "react-redux";
type PropsType = ConnectedProps<typeof connector>;

type ConstructorType = {}

class AccountCreationViewComponent extends React.Component<
  PropsType,
  ConstructorType
> {
  private usernameInputRef: any;
  private passwordInputRef: any;

  constructor(props: PropsType) {
    super(props);
    this.usernameInputRef = React.createRef();
    this.passwordInputRef = React.createRef();
  }

  handleLogin(event: any) {
      let username = this.usernameInputRef.value;
      let password = this.passwordInputRef.value;

      return login(username,password).then((res) => {
        return this.props.checkUserSession().then(() => {
          return this.props.updateUserSubscriptions();
        })
      }).catch((err) => {console.log(err)});
  }

  handleLogout(event : any) {
    return logout().then((res : any) => {
      return this.props.checkUserSession().then(() => {
        if(!this.props.session) {
          return this.props.clearUserSubscriptions();
        }
      })
    }).catch((err) => {
      console.log(err);
    })
  }

  handleCreateAccount(event: any) {
    let username = this.usernameInputRef.value;
    let password = this.passwordInputRef.value;
    
    return createAccount(username,password).then((res) => {
      return this.props.checkUserSession().then(() => {
         if(this.props.session) {
            return this.props.updateUserSubscriptions();
         }
      })
    }).catch((err) => {console.log(err)});
  }

  render(): any {
    let loginForm = (
      <form
        onSubmit={(e) => {
          e.preventDefault();
        }}
      >
        <label htmlFor="usernameInput">Username</label>
        <input
          name="usernameInput"
          type="normal"
          ref={(r) => {
            this.usernameInputRef = r;
          }}
        ></input>
        <label htmlFor="passwordInput">Password</label>
        <input
          name="passwordInput"
          type="password"
          ref={(r) => {
            this.passwordInputRef = r;
          }}
        ></input>
        <button
          type="submit"
          onClick={(e) => {
            this.handleCreateAccount(e);
          }}
        >
          Create Account
        </button>
        <button
          type="submit"
          onClick={(e) => {
            this.handleLogin(e);
          }}
        >
          Log in
        </button>
      </form>
    );
    let logoutForm = <div>You're already logged in, my friend.
        <button
          type="submit"
          onClick={(e) => {
            this.handleLogout(e);
          }}
        >
          Log Out 
        </button>
    </div>;

    let shown = this.props.session ? logoutForm : loginForm;

    return <div>{shown}</div>;
  }
}
function mapStateToProps(state: RootState) {
  return {
    session: state.accountReducer.hasSession
  };
}

function mapDispatchToProps(dispatch: any) {
  return {
    checkUserSession: () => {
      return dispatch(checkUserSessionAction());
    },

    updateUserSubscriptions: () => {
      return dispatch(updateAccountSubscriptionsAction("fakeusername")); //TODO: unhardcode this
    },

    clearUserSubscriptions: () => {
      return dispatch(clearAccountSubscriptionsAction());
    }
  };
}

const connector = connect(mapStateToProps, mapDispatchToProps);
export default connector(AccountCreationViewComponent);
