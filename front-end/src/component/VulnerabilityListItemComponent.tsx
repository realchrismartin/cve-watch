import React from "react";
import "../css/VulnerabilityListItemComponent.css";
import SoftwareSearchListItemComponent from "./SoftwareSearchListItemComponent";

type PropsType = {
  data: any;
  onClick: any;
  inputRef: any;
};
type ComponentType = {
  expanded: boolean;
};

class VulnerabilityListItemComponent extends React.Component<
  PropsType,
  ComponentType
> {
  constructor(props: PropsType) {
    super(props);
    this.state = {
      expanded: false,
    };
  }

  handleOnClick() {
    if (this.state.expanded) {
      this.setState({ expanded: false });
    } else {
      this.setState({ expanded: true });
    }

    if (this.props.onClick !== undefined) {
      this.props.onClick();
    }
  }

  render() {
    let itemCSSClassName = this.state.expanded
      ? "vulnerability-list-item vulnerability-list-item-expanded"
      : "vulnerability-list-item vulnerability-list-item-collapsed";
    let detailCSSClassName = this.state.expanded
      ? "vulnerability-list-item-detail vulnerability-list-item-detail-expanded"
      : "vulnerability-list-item-detail vulnerability-list-item-detail-collapsed";

    let id: string;
    let score: number;
    let severity: string;
    let exploitability: string;
    let impact: string;
    let description: string;
    let references: any[];
    let software: any[];

    try {
      id = this.props.data["cve"]["CVE_data_meta"]["ID"];
    } catch (error) {
      id = "CVE-2099-9999";
    }

    try {
      score = this.props.data["impact"]["baseMetricV2"]["cvssV2"]["baseScore"];
    } catch (error) {
      score = 0;
    }

    try {
      severity = this.props.data["impact"]["baseMetricV2"]["severity"];
    } catch (error) {
      severity = "n/a";
    }

    try {
      exploitability = this.props.data["impact"]["baseMetricV2"][
        "exploitabilityScore"
      ];
    } catch (error) {
      exploitability = "n/a";
    }

    try {
      impact = this.props.data["impact"]["baseMetricV2"]["impactScore"];
    } catch (error) {
      impact = "n/a";
    }

    try {
      references = this.props.data["cve"]["references"]["reference_data"].map(
        (it: any) => {
          return it["url"];
        }
      );
    } catch (error) {
      references = [];
    }

    try {
      software = this.props.data["configurations"]["nodes"].map((it: any) => {
        return it["cpe_match"].map((it2: any) => {
          return it2["cpe23Uri"];
        });
      });

      software = software.reduce((acc: string[], it: string[]) => {
        return acc.concat(it);
      });

      software = software.map((it: string, index: number) => {
        return (
          <SoftwareSearchListItemComponent
            simple={true}
            key={"cpe-list-item-" + index}
            data={it}
          />
        );
      });
    } catch (error) {
      software = [<div></div>];
    }

    try {
      description = this.props.data["cve"]["description"][
        "description_data"
      ][0]["value"];
    } catch (error) {
      description = "";
    }

    let scoreCSS = "cvss-score cvss-score-hidden";

    if (score > 0) {
      switch (true) {
        case score > 7: {
          scoreCSS = "cvss-score cvss-score-high";
          break;
        }
        case score <= 7 && score >= 3: {
          scoreCSS = "cvss-score cvss-score-medium";
          break;
        }
        case score < 3: {
          scoreCSS = "cvss-score cvss-score-low";
          break;
        }
        default: {
          break;
        }
      }
    }

    /* Define expand/collapse button */
    let expandButton = (
      <span className="vulnerability-list-item-expand-button">
        <svg
          onClick={() => {
            this.handleOnClick();
          }}
          xmlns="http://www.w3.org/2000/svg"
          className="vulnerability-list-item-expand-button-icon"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fillRule="evenodd"
            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
            clipRule="evenodd"
          />
        </svg>
      </span>
    );

    let collapseButton = (
      <span className="vulnerability-list-item-expand-button">
        <svg
          onClick={() => {
            this.handleOnClick();
          }}
          xmlns="http://www.w3.org/2000/svg"
          className="vulnerability-list-item-expand-button-icon"
          fill="none"
          viewBox="0 0 20 20"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M9 5l7 7-7 7"
          />
        </svg>
      </span>
    );

    let controlCardSizeButton = this.state.expanded
      ? collapseButton
      : expandButton;

    return (
      <div className={itemCSSClassName} ref={this.props.inputRef}>
        <span className="vulnerability-list-item-id">
          <span>{controlCardSizeButton}</span>
          <span>{id}</span>
          <span className={scoreCSS}>CVSS: {score}</span>
        </span>
        <div className={detailCSSClassName}>
          <div>Affects</div>
          <div>className="vulnerability-property"{software}</div>
          <div className="vulnerability-property">Severity: {severity}</div>
          <div className="vulnerability-property">
            Exploitability: {exploitability}
          </div>
          <div className="vulnerability-property">Impact: {impact}</div>
          <div className="vulnerability-description">
            {description}
          </div>
          <div className="vulnerability-property">References:{references}</div>
        </div>
      </div>
    );
  }
}

export default VulnerabilityListItemComponent;
