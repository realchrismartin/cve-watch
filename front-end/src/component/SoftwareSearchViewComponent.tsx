import React from "react";
import { RootState } from "../store";
import { ConnectedProps, connect } from "react-redux";
import {
  getCPESoftwareAction,
  getRepoSoftwareAction,
} from "../action/SoftwareAction";

import "../css/SoftwareSearchViewComponent.css";
import SoftwareSearchListItemComponent from "./SoftwareSearchListItemComponent";

type ConstructorType = {
  loading: boolean;
  prevMax: number;
};
type PropsType = ConnectedProps<typeof connector>;

class SoftwareSearchViewComponent extends React.Component<
  PropsType,
  ConstructorType
> {
  private loadingRef: any;
  private observer: IntersectionObserver;
  private githubRepoURLRegex: RegExp;

  constructor(props: PropsType) {
    super(props);

    this.state = {
      loading: false,
      prevMax: 0,
    };

    this.githubRepoURLRegex = new RegExp(
      /^(https{0,1}:\/\/)(api){0,1}github.com\/(.*?)\/(.*?)$/
    );

    this.loadingRef = React.createRef();

    this.observer = new IntersectionObserver(this.checkScroll.bind(this), {
      root: null,
      rootMargin: "0%",
      threshold: 0.2,
    });
  }

  componentDidMount() {
    //Set up an observer to watch loadingRef / trigger loading of more CPEs
    this.observer.observe(this.loadingRef);
  }

  /* Callback called by IntersectionObserver when scroll loading div is in viewport */
  checkScroll(entities: any[], observer: IntersectionObserver) {
    //TODO: Add a bypass if all of the records have been retrieved already (maxForFilter is reached)
    let yPos = entities[0].boundingClientRect.y;

    if (
      this.state.prevMax > yPos &&
      this.props.software.length > 0 &&
      !this.state.loading
    ) {
      this.setState({ loading: true });

      let isQueryRepo = this.props.query.match(this.githubRepoURLRegex);

      if (isQueryRepo) {
        this.props
          .getRepoSoftware(
            isQueryRepo[3],
            isQueryRepo[4],
            this.props.software.length,
            this.props.pageSize
          )
          .then(() => {
            this.setState({ loading: false });
          })
          .catch((err: Error) => {
            console.log(err);
          });
      } else {
        return this.props
          .getCPESoftware(
            this.props.query,
            this.props.software.length,
            this.props.pageSize
          )
          .then(() => {
            this.setState({ loading: false });
          })
          .catch((err: Error) => {
            console.log(err);
          });
      }
    }

    this.setState({ prevMax: yPos });
  }
  render(): any {
    let softwareListItems = [];

    if (this.props.software !== undefined) {
      softwareListItems = this.props.software.map((it: any, index: number) => {
        return (
          <SoftwareSearchListItemComponent
            simple={false}
            key={"software-list-item-" + index}
            data={it}
          />
        );
      });
    }

    return (
      <div>
        <div className="software-loading-indicator">
          <svg
            className={
              this.state.loading
                ? "software-loading-indicator-on"
                : "software-loading-indicator-off"
            }
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 25 25"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
            />
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
            />
          </svg>
        </div>
        <div className="software-list">
          {softwareListItems}
          <div
            ref={(loadingRef) => (this.loadingRef = loadingRef)}
            className="software-search-scroll-space"
          >
            {" "}
          </div>
        </div>
      </div>
    );
  }
}

function mapStateToProps(state: RootState) {
  return {
    account: state.accountReducer.account,
    software: state.softwareReducer.software,
    query: state.softwareReducer.query,
    pageSize: state.settingsReducer.pageSize,
  };
}

function mapDispatchToProps(dispatch: any) {
  return {
    getCPESoftware: (query: string, startAt: number, pageSize: number) => {
      return dispatch(getCPESoftwareAction(query, startAt, pageSize));
    },

    getRepoSoftware: (
      user: string,
      repo: string,
      startAt: number,
      pageSize: number
    ) => {
      return dispatch(getRepoSoftwareAction(user, repo, startAt, pageSize));
    },
  };
}

const connector = connect(mapStateToProps, mapDispatchToProps);
export default connector(SoftwareSearchViewComponent);
