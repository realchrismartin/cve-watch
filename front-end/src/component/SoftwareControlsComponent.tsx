import React from "react";
import { RootState } from "../store";
import { connect, ConnectedProps } from "react-redux";
import "../css/SoftwareControlsComponent.css";
import { debounce } from "lodash";
import {
  clearSoftwareAction,
  getCPESoftwareAction,
  getRepoSoftwareAction,
  setSoftwareQueryAction,
} from "../action/SoftwareAction";

type PropsType = ConnectedProps<typeof connector>;
type ConstructorType = {
  loading: boolean;
  queryMinLength: number;
  queryDebounceTimeout: number;
  prevMax: number;
};
class SoftwareControlsComponent extends React.Component<
  PropsType,
  ConstructorType
> {
  private searchInputRef: any;
  private githubRepoURLRegex: RegExp;

  private handleQueryChangeDebounced: any;

  constructor(props: PropsType) {
    super(props);

    this.state = {
      loading: false,
      queryMinLength: 3,
      queryDebounceTimeout: 1000,
      prevMax: 0,
    };
    this.githubRepoURLRegex = new RegExp(
      /^(https{0,1}:\/\/)(api){0,1}github.com\/(.*?)\/(.*?)$/
    );

    this.searchInputRef = React.createRef();

    this.handleQueryChange = this.handleQueryChange.bind(this);
    this.handleQueryChangeDebounced = debounce(() => {
      this.handleQueryChange();
    }, this.state.queryDebounceTimeout);
  }

  /* Handles executing a query if the query string has changed */
  handleQueryChange() {
    if (this.searchInputRef === null) {
      return;
    }

    let query = this.searchInputRef.value;

    if (query.length <= this.state.queryMinLength) {
      return;
    }

    this.setState({ loading: true });
    
    this.props.clearSoftware().then(() => {
      this.props.setSoftwareQuery(query).then(() => {

        let isQueryRepo = query.match(this.githubRepoURLRegex);

        if (isQueryRepo) {
          this.props
            .getRepoSoftware(
              isQueryRepo[3],
              isQueryRepo[4],
              this.props.software.length,
              this.props.pageSize
            )
            .then(() => {
              this.setState({ loading: false });
            })
            .catch((err: Error) => {
              console.log(err);
            });
        } else {
          this.props
            .getCPESoftware(
              this.props.query,
              this.props.software.length,
              this.props.pageSize
            )
            .then(() => {
              this.setState({ loading: false });
            })
            .catch((err: Error) => {
              console.log(err);
            });
        }
      });
    });
  }
  render() {
    return (
      <div className="software-controls">
        <form
          onSubmit={(e) => {
            e.preventDefault();
            this.handleQueryChangeDebounced();
          }}
        >
          <input
            ref={(inputRef) => (this.searchInputRef = inputRef)}
            minLength={this.state.queryMinLength}
            disabled={this.state.loading}
          />
        </form>
        <svg
          className="software-controls-icon"
          onClick={(e) => {
            this.handleQueryChangeDebounced();
          }}
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 25 25"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth="2"
            d="M8 16l2.879-2.879m0 0a3 3 0 104.243-4.242 3 3 0 00-4.243 4.242zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
      </div>
    );
  }
}
function mapStateToProps(state: RootState) {
  return {
    software: state.softwareReducer.software,
    query: state.softwareReducer.query,
    pageSize: state.settingsReducer.pageSize,
  };
}

function mapDispatchToProps(dispatch: any) {
  return {
    getCPESoftware: (query: string, startAt: number, pageSize: number) => {
      return dispatch(getCPESoftwareAction(query, startAt, pageSize));
    },

    getRepoSoftware: (
      user: string,
      repo: string,
      startAt: number,
      pageSize: number
    ) => {
      return dispatch(getRepoSoftwareAction(user, repo, startAt, pageSize));
    },
    clearSoftware: () => {
      return dispatch(clearSoftwareAction());
    },
    setSoftwareQuery: (query: string) => {
      return dispatch(setSoftwareQueryAction(query));
    },
  };
}

const connector = connect(mapStateToProps, mapDispatchToProps);
export default connector(SoftwareControlsComponent);
