import React from "react";
import { RootState } from "../store";
import { connect, ConnectedProps } from "react-redux";
import {
  clearVulnerabilitiesAction,
  getVulnerabilitiesAction,
} from "../action/VulnerabilityAction";
import {
  clearFilterAction,
  setFilterAction,
  toggleFilterOnAction,
  toggleFilterOffAction,
} from "../action/FilterAction";
import {
  toggleSubscriptionOnAction,
  toggleSubscriptionOffAction,
} from "../action/AccountAction";

import { debounce } from "lodash";
import sanitizeString from "../util/SanitizeString";

import "../css/VulnerabilityControlsComponent.css";
import SVGButton from "./SVGButton";

type PropsType = ConnectedProps<typeof connector>;

type ConstructorType = {
  loading: boolean;
  filterExpanded: boolean;
  filterMinLength: number;
  filterDebounceTimeout: number;
  filterHasUnappliedChanges: boolean;
};

/* Represents the control bar for vulnerability view */
class VulnerabilityControlsComponent extends React.Component<
  PropsType,
  ConstructorType
> {
  private filterInputRef: any;
  private handleApplyingFiltersAndSubscriptionsDebounced: any;

  constructor(props: PropsType) {
    super(props);
    this.filterInputRef = React.createRef();
    this.state = {
      loading: false,
      filterExpanded: true,
      filterMinLength: 4,
      filterDebounceTimeout: 1000,
      filterHasUnappliedChanges: false,
    };
    /* Add debouncer to filter apply button */
    this.handleApplyingFiltersAndSubscriptions = this.handleApplyingFiltersAndSubscriptions.bind(
      this
    );
    this.handleApplyingFiltersAndSubscriptionsDebounced = debounce(() => {
      this.handleApplyingFiltersAndSubscriptions();
    }, this.state.filterDebounceTimeout);
  }
  /*Handles expanding/contracting settings pane*/
  handleExpandFilter() {
    this.state.filterExpanded
      ? this.setState({ filterExpanded: false })
      : this.setState({ filterExpanded: true });
  }

  /*Handle forcibly expanding the settings pane (set to true regardless of state)*/
  handleForceExpandFilter() {
    this.setState({ filterExpanded: true });
  }

  /* Handles adding newly entered filter strings to state */
  async handleFilterChange(): Promise<void> {
    return new Promise((resolve, reject) => {
      this.setState({ filterExpanded: true });

      if (this.filterInputRef !== null) {
        let newFilter = this.filterInputRef.value;

        if (newFilter.length > this.state.filterMinLength) {
          this.filterInputRef.value = "";
          this.props.setFilter(newFilter);
        }
      }

      this.setState({ filterHasUnappliedChanges: true });
      resolve();
    });
  }

  /* Handles toggling filter strings */
  handleToggleFilter(filter: string) {
    if (this.props.toggledFilters.indexOf(filter) !== -1) {
      this.props.toggleFilterOff(filter);
    } else {
      this.props.toggleFilterOn(filter);
    }

    this.setState({ filterHasUnappliedChanges: true });
  }

  /* Handles clearing filters */
  handleClearFilter(filter: string) {
    this.props.clearFilter(filter);
    this.setState({ filterHasUnappliedChanges: true });
  }

  /* Handles toggling subscription filter strings */
  handleToggleSubscription(subscription: string) {
    if (this.props.toggledSubscriptions.indexOf(subscription) !== -1) {
      this.props.toggleSubscriptionOff(subscription);
    } else {
      this.props.toggleSubscriptionOn(subscription);
    }
    this.setState({ filterHasUnappliedChanges: true });
  }

  /* Handles updating store data based on applied filter and subscription filter strings */
  handleApplyingFiltersAndSubscriptions() {
    if (!this.state.loading) {
      this.setState({ loading: true, filterExpanded: false });
      this.props.clearVulnerabilities().then(() => {
        this.props
          .getVulnerabilities(
            this.props.toggledFilters,
            this.props.toggledSubscriptions,
            0,
            this.props.pageSize
          )
          .then(() => {
            this.setState({ loading: false, filterHasUnappliedChanges: false });
          })
          .catch((err: any) => {
            console.log(err);
          });
      });
    }
  }

  render() {
    let vulnerabilityControlsCSSClass = this.state.filterExpanded
      ? "vulnerability-controls-item-expanded"
      : "vulnerability-controls-item-collapsed";

    let vulnerabilityControlsBoxCSSClass = this.state.filterExpanded
      ? "vulnerability-controls-expanded"
      : "vulnerability-controls-collapsed";

    let hideFiltersIfEmptyCSSClass =
      this.props.filters.length + this.props.subscriptions.length > 0
        ? ""
        : "vulnerability-controls-filter-collapsed";

    let filterPendingChangesCSSClass = this.state.filterHasUnappliedChanges
      ? "filter-pending-apply"
      : "filter-applied";

    let filterContainerCSSClass =
      this.state.filterExpanded &&
      this.props.filters.length + this.props.subscriptions.length > 0
        ? "vulnerability-controls-filter-container vulnerability-controls-filter-container-expanded"
        : "vulnerability-controls-filter-container vulnerability-controls-filter-container-collapsed";

    let appliedFilterCount =
      this.props.toggledFilters.length + this.props.toggledSubscriptions.length;

    let appliedFilterCountCSSClass =
      appliedFilterCount > 0
        ? "applied-filter-count-shown"
        : "applied-filter-count-hidden";
    let filters = this.props.filters.map((it: string, index: number) => {
      let toggleCheckbox = (
        <input
          className={
            "vulnerability-controls-checkbox " + vulnerabilityControlsCSSClass
          }
          type="checkbox"
          defaultChecked={true}
          onChange={(e) => {
            this.handleToggleFilter(it);
          }}
        ></input>
      );

      let clearButton = (
        <SVGButton
          type={13}
          size="small"
          onClick={(e: any) => {
            this.handleClearFilter(it);
          }}
          hoverText={"Remove this filter"}
          stroke={"currentColor"}
          viewBox={"0 0 24 24"}
        />
      );

      return (
        <span key={index} className={vulnerabilityControlsCSSClass}>
          <span>{toggleCheckbox}</span>
          <span>{it}</span>
          <span>{clearButton}</span>
        </span>
      );
    });

    let subscriptionFilters = this.props.subscriptions.map((it: string, index:number) => {
      let toggleCheckbox = (
        <input
          className={
            "vulnerability-controls-checkbox" + vulnerabilityControlsCSSClass
          }
          type="checkbox"
          defaultChecked={true}
          onChange={(e) => {
            this.handleToggleSubscription(it);
          }}
        ></input>
      );

      //Show only the friendly name for CPEs
      let value = it;
      if (it.startsWith("cpe:")) {
        value = it.split(":")[4];
      }

      return (
        <div key={index} className={vulnerabilityControlsCSSClass}>
          {toggleCheckbox} {"[w] " + value}
        </div>
      );
    });

    return (
      <div className="vulnerability-controls">
        <SVGButton
          className={
            this.state.loading
              ? "svg-button vulnerability-loading-indicator-on"
              : "svg-button vulnerability-loading-indicator-off"
          }
          type={8}
          stroke={"currentColor"}
          viewBox={"0 0 24 24"}
          hoverText={"Searching for vulnerabilities, please wait..."}
        />
        <div className={appliedFilterCountCSSClass}>{appliedFilterCount}</div>
        <SVGButton
          type={11}
          onClick={() => {
            this.handleExpandFilter();
          }}
          hoverText="Show/Hide filters"
          stroke={"currentColor"}
          viewBox={"0 0 24 24"}
        />
        <div>
          <form
            onSubmit={(e) => {
              e.preventDefault();
              if (this.filterInputRef !== null) {
                if(this.filterInputRef.value.length > this.state.filterMinLength) {
                  this.handleFilterChange().then(() => {
                    this.handleApplyingFiltersAndSubscriptionsDebounced();
                  });
                }
              }
            }}
          >
            <input
              id="vulnerabilityListFilterInput"
              ref={(inputRef) => (this.filterInputRef = inputRef)}
              minLength={this.state.filterMinLength + 1}
              disabled={this.state.loading}
              placeholder="Search vulnerabilities..."
              onFocus={() => {
                this.handleForceExpandFilter();
              }}
            />
          </form>
        </div>
        <div className={filterPendingChangesCSSClass}>
          <SVGButton
            type={8}
            onClick={() => {
              this.handleFilterChange().then(() => {
                this.handleApplyingFiltersAndSubscriptionsDebounced();
              });
            }}
            hoverText={"Apply filters and search NVD"}
            stroke={"currentColor"}
            viewBox={"0 0 24 24"}
          />
        </div>

        <div className={filterContainerCSSClass}>
          <div
            className={
              "vulnerability-controls-filter " +
              vulnerabilityControlsBoxCSSClass +
              " " +
              hideFiltersIfEmptyCSSClass
            }
          >
            {filters}
            {subscriptionFilters}
          </div>
        </div>
      </div>
    );
  }
}
function mapStateToProps(state: RootState) {
  return {
    filters: state.filterReducer.filters,
    toggledFilters: state.filterReducer.toggledFilters,
    pageSize: state.settingsReducer.pageSize,
    session: state.accountReducer.hasSession,
    subscriptions: state.accountReducer.subscriptions,
    toggledSubscriptions: state.accountReducer.toggledSubscriptions,
  };
}

function mapDispatchToProps(dispatch: any) {
  return {
    getVulnerabilities: (
      query: string[],
      subscriptions: string[],
      startAt: number,
      pageSize: number
    ) => {
      let terms = "";

      let allTerms = [...query, ...subscriptions];

      if (allTerms.length > 0) {
        terms = allTerms.reduce((val, it) => {
          return val + "+" + sanitizeString(it);
        });
      }

      return dispatch(getVulnerabilitiesAction(terms, startAt, pageSize));
    },

    clearVulnerabilities: () => {
      return dispatch(clearVulnerabilitiesAction());
    },

    setFilter: (filter: string) => {
      return dispatch(setFilterAction(filter));
    },

    clearFilter: (filter: string) => {
      return dispatch(clearFilterAction(filter));
    },

    toggleFilterOn: (filter: string) => {
      return dispatch(toggleFilterOnAction(filter));
    },

    toggleSubscriptionOn: (filter: string) => {
      return dispatch(toggleSubscriptionOnAction(filter));
    },

    toggleFilterOff: (filter: string) => {
      return dispatch(toggleFilterOffAction(filter));
    },

    toggleSubscriptionOff: (filter: string) => {
      return dispatch(toggleSubscriptionOffAction(filter));
    },
  };
}

const connector = connect(mapStateToProps, mapDispatchToProps);
export default connector(VulnerabilityControlsComponent);
