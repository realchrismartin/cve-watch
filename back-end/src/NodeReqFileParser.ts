import IReqFileParser from "./IReqFileParser";
import IDependency from "./IDependency";
import Dependency from "./Dependency";

class NodeReqFileParser implements IReqFileParser {
    parseDependencies = async(fileBody : string) : Promise<IDependency[]> => {
        return new Promise((resolve,reject) => {
            let dependencies : IDependency[] = [];

            try {
                let dependencyFile = JSON.parse(fileBody);

                let allDependencies = { ...dependencyFile.dependencies, ...dependencyFile.devDependencies, ...dependencyFile.peerDependencies }

                for(let dep in allDependencies) {
                    let version = dependencyFile.dependencies[dep]
                    let versionElements = version.split(".");
                    if(versionElements.length != 3) {
                        throw new Error("Invalid version length for dependency " + dep);
                    }
                   dependencies.push(new Dependency(dep,versionElements[0],versionElements[1],versionElements[2]));
                }
                resolve(dependencies);
            } catch(err) {
                reject(err);
            };
        });
    } 
}

export default NodeReqFileParser;