trigger:
  branches:
    include:
      - master

resources:
  - repo: self

variables:
  # Container registry service connection established during pipeline creation
  azureSubscriptionEndpoint: "cvewatch-azurerm-serviceconnection-2"
  imageRepository: "cvewatch"
  containerRegistry: "cvewatchcr.azurecr.io"
  tag: "$(Build.BuildId)"
  REACT_APP_BACKEND_HOST: "http://cvewatch-back.azurewebsites.net"
  FRONT_END_HOST: "http://cvewatch-app.azurewebsites.net"
  MONGODB_URI: "mongodb://cve-watch-db:t5sAGI8Ta2G6otLOTeYudkyg5gqtO0IDsBimHhRnyFIsMJWsQYUNIpNaSG5oimnTxbsWPfkcRVWlgAfUyCl4AA==@cve-watch-db.mongo.cosmos.azure.com:10255/?ssl=true&replicaSet=globaldb&retrywrites=false&maxIdleTimeMS=120000&appName=@cve-watch-db@"

  # Agent VM image name
  vmImageName: "ubuntu-latest"

stages:
  - stage: Build
    displayName: Build stage
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)
        steps:
        - task: DockerCompose@0
          displayName: Build services
          inputs:
            action: Build services
            azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
            azureContainerRegistry: $(containerRegistry)
            dockerComposeFile: docker-compose.yml
            projectName: $(Build.Repository.Name)
            qualifyImageNames: true
            additionalImageTags: $(Build.BuildId)
        - task: DockerCompose@0
          displayName: Push to Container Registry
          inputs:
            action: Push services
            azureSubscriptionEndpoint: $(azureSubscriptionEndpoint)
            azureContainerRegistry: $(containerRegistry)
            dockerComposeFile: docker-compose.yml
            projectName: $(Build.Repository.Name)
            qualifyImageNames: true
            additionalImageTags: $(Build.BuildId)